version: "3.9"

services:
  backend:
    build: ./backend
    container_name: dus-fr-backend
    environment:
      - PORT=${PORT:-4000}
      - PUBLIC_API_URL=${PUBLIC_API_URL:-http://localhost:4000}
      - MONGO_URI=${MONGO_URI:-mongodb://mongo:27017/dusfr}
      - JWT_SECRET=${JWT_SECRET:-supersecretjwt}
      - MINIO_ENDPOINT=${MINIO_ENDPOINT:-minio}
      - MINIO_PORT=${MINIO_PORT:-9000}
      - MINIO_USE_SSL=${MINIO_USE_SSL:-false}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY:-minioadmin}
      - MINIO_BUCKET=${MINIO_BUCKET:-media}
      - MINIO_PUBLIC_URL=${MINIO_PUBLIC_URL:-http://localhost:9000}
      - SEED_USER_EMAIL=${SEED_USER_EMAIL:-engineer@example.com}
      - SEED_USER_PASSWORD=${SEED_USER_PASSWORD:-password123}
      - SEED_USER_NAME=${SEED_USER_NAME:-Default Engineer}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
      - OPENAI_REPORT_MODEL=${OPENAI_REPORT_MODEL:-gpt-4o}
      - OPENAI_TRANSCRIBE_MODEL=${OPENAI_TRANSCRIBE_MODEL:-gpt-4o-mini-transcribe}
      - OPENAI_TIMEOUT_MS=${OPENAI_TIMEOUT_MS:-60000}
    ports:
      - "${BACKEND_PORT:-4000}:4000"
    depends_on:
      - mongo
      - minio
    networks:
      default: {}
      shared_caddy_net:
        aliases:
          - dus-fr-backend

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
      args:
        VITE_API_URL: ${VITE_API_URL}
    container_name: dus-fr-frontend
    restart: unless-stopped
    networks:
      default: {}
      shared_caddy_net:
        aliases:
          - dus-fr-frontend

  mongo:
    image: mongo:6
    container_name: dus-fr-mongo
    restart: unless-stopped
    volumes:
      - mongo-data:/data/db
    ports:
      - "${MONGO_PORT:-27017}:27017"

  minio:
    image: minio/minio:RELEASE.2024-04-06T05-26-02Z
    container_name: dus-fr-minio
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin}
    volumes:
      - minio-data:/data
    ports:
      - "${MINIO_API_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"

volumes:
  mongo-data:
  minio-data:

networks:
  # Docker Compose creates this implicitly; declaring it keeps intent clear since
  # backend/frontend are attached to multiple networks.
  default: {}
  shared_caddy_net:
    external: true
    name: shared_caddy_net
